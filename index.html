<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Outlive Zone 2 Challenge</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      html, body, #root { height: 100%; }
      .month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
      .weekday-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      // ================== CONFIG ==================
      const CONFIG = {
        participants: [
          { name: "Jos", pin: "1111" },
          { name: "Tom", pin: "2222" },
          { name: "Gerben Jan", pin: "3333" }
        ],
        goals: { Easy: 1750, Medium: 2100, Hard: 2500 }
      };

      // ================== HELPERS ==================
      const YMD = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
      const fromYMD = s => new Date(`${s}T00:00:00`);

      function currentYear() { return new Date().getFullYear(); }
      function challengeRange() {
        const y = currentYear();
        return { start: new Date(`${y}-11-01T00:00:00`), end: new Date(`${y}-12-31T00:00:00`) };
      }

      function enumerateDays(start, end) {
        const out = [];
        const d = new Date(start);
        while (d <= end) { out.push(YMD(d)); d.setDate(d.getDate() + 1); }
        return out;
      }

      function daysBetweenInclusive(d1, d2) {
        const a = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate());
        const b = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate());
        const ms = b - a;
        return Math.floor(ms / 86400000) + 1;
      }

      function radialStyle() {
        return {
          background: "radial-gradient(1200px circle at 50% 20%, rgba(255,255,255,1) 0%, rgba(255,255,255,1) 25%, rgba(210,236,255,0.9) 38%, rgba(232,249,225,0.85) 52%, rgba(255,238,246,0.85) 66%, rgba(255,255,255,1) 100%)",
          minHeight: "100vh"
        };
      }

      const classNames = (...a) => a.filter(Boolean).join(" ");

      const QUOTES = [
        "When you think you are done, you are only 40 percent done.",
        "Stay disciplined when motivation fades.",
        "You do not find toughness, you build it.",
        "Every minute counts, stay hard.",
        "It is you versus you, no one else.",
        "Be uncommon amongst uncommon people.",
        "Suffering is the true test of life."
      ];
      const pickQuote = () => QUOTES[Math.floor(Math.random() * QUOTES.length)];

      const LS_KEY = "outlive_zone2_data_v3";
      const loadLocal = () => { try { return JSON.parse(localStorage.getItem(LS_KEY)) || {}; } catch { return {}; } };
      const saveLocal = db => localStorage.setItem(LS_KEY, JSON.stringify(db));

      // Maandhelpers
      function getMonthMatrix(year, monthIndex) {
        const first = new Date(year, monthIndex, 1);
        const last = new Date(year, monthIndex + 1, 0);
        const daysInMonth = last.getDate();
        const startWeekday = (first.getDay() + 6) % 7; // maandag als 0
        const cells = [];
        for (let i = 0; i < startWeekday; i++) cells.push(null);
        for (let d = 1; d <= daysInMonth; d++) cells.push(new Date(year, monthIndex, d));
        while (cells.length % 7 !== 0) cells.push(null);
        return cells;
      }

      const WEEKDAYS = ["Ma","Di","Wo","Do","Vr","Za","Zo"];

      // ================== APP ==================
      function App() {
        const { start, end } = React.useMemo(() => challengeRange(), []);
        const allDays = React.useMemo(() => enumerateDays(start, end), [start, end]);

        const [db, setDb] = React.useState(loadLocal());
        const [user, setUser] = React.useState(null);
        const [quote, setQuote] = React.useState("");
        const [modal, setModal] = React.useState(null); // { dateYMD, value }

        React.useEffect(() => saveLocal(db), [db]);

        function ensureUser(name) {
          setDb(cur => {
            if (!cur[name]) cur[name] = { level: null, entries: {} };
            return { ...cur };
          });
        }

        function setLevel(name, level) {
          setDb(cur => {
            const next = { ...cur };
            next[name] = next[name] || { level: null, entries: {} };
            if (!next[name].level) next[name].level = level;
            return next;
          });
        }

        function setMinutes(name, ymd, mins) {
          setDb(cur => {
            const next = { ...cur };
            next[name] = next[name] || { level: null, entries: {} };
            next[name].entries = { ...next[name].entries, [ymd]: mins };
            return next;
          });
        }

        function resetEntries(name) {
          if (!confirm("Weet je zeker dat je alle minuten wilt resetten voor deze deelnemer")) return;
          setDb(cur => {
            const next = { ...cur };
            const level = next[name]?.level || null;
            next[name] = { level, entries: {} };
            return next;
          });
        }

        function totalFor(n) {
          const rec = db[n];
          if (!rec) return 0;
          return Object.values(rec.entries || {}).reduce((a, b) => a + (parseInt(b || 0, 10) || 0), 0);
        }

        function goalFor(n) {
          const rec = db[n];
          if (!rec || !rec.level) return 0;
          return CONFIG.goals[rec.level];
        }

        function remainingDaysFromToday(today = new Date()) {
          const { start, end } = challengeRange();
          const t0 = new Date(Math.max(today.setHours(0,0,0,0), new Date(start).setHours(0,0,0,0)));
          const endNorm = new Date(end.getFullYear(), end.getMonth(), end.getDate());
          if (t0 > endNorm) return 0;
          return daysBetweenInclusive(t0, endNorm);
        }

        const leaderboard = React.useMemo(() =>
          CONFIG.participants
            .map(p => {
              const g = goalFor(p.name);
              const s = totalFor(p.name);
              const pct = g ? Math.min(100, Math.round((s / g) * 100)) : 0;
              return { name: p.name, goal: g, sum: s, pct };
            })
            .sort((a, b) => b.pct - a.pct || b.sum - a.sum),
        [db]);

        return (
          <div style={radialStyle()} className="text-slate-900">
            <div className="max-w-6xl mx-auto px-4 py-8">
              <Header />
              {!user ? (
                <LoginScreen onLogin={setUser} ensureUser={ensureUser} setLevel={setLevel} />
              ) : (
                <MainScreen
                  user={user}
                  db={db}
                  allDays={allDays}
                  setUser={setUser}
                  totalFor={totalFor}
                  goalFor={goalFor}
                  remainingDaysFromToday={remainingDaysFromToday}
                  openModal={(ymd, current) => setModal({ dateYMD: ymd, value: current })}
                  resetEntries={resetEntries}
                  leaderboard={leaderboard}
                />
              )}

              {modal && user && (
                <MinutesModal
                  dateYMD={modal.dateYMD}
                  initialValue={modal.value}
                  onCancel={() => setModal(null)}
                  onSave={(val) => {
                    setMinutes(user.name, modal.dateYMD, val);
                    setModal(null);
                    setQuote(pickQuote());
                  }}
                />
              )}

              {quote && (
                <div className="fixed inset-x-0 bottom-0 p-4">
                  <div className="max-w-3xl mx-auto rounded-2xl bg-white/90 backdrop-blur shadow-lg p-4 text-center border border-slate-200">
                    <p className="text-lg font-medium italic">{quote}</p>
                    <button className="mt-3 px-4 py-2 rounded-xl bg-slate-900 text-white" onClick={() => setQuote("")}>Sluiten</button>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      // ================== UI COMPONENTS ==================
      const Header = () => (
        <div className="mb-8 text-center">
          <div className="text-xs tracking-widest text-slate-600">Zone 2 Challenge</div>
          <h1 className="text-4xl md:text-5xl font-semibold tracking-tight mt-1">Outlive Zone 2</h1>
          <p className="text-slate-600 mt-2">November en december</p>
        </div>
      );

      function LoginScreen({ onLogin, ensureUser, setLevel }) {
        const [name, setName] = React.useState(CONFIG.participants[0].name);
        const [pin, setPin] = React.useState("");
        const [level, setLevelLocal] = React.useState("Easy");
        const [error, setError] = React.useState("");

        function handleLogin() {
          const p = CONFIG.participants.find(x => x.name === name);
          if (!p || p.pin !== pin) { setError("Verkeerde pincode"); return; }
          ensureUser(name);
          setLevel(name, level);
          onLogin({ name });
        }

        return (
          <div className="max-w-4xl mx-auto grid md:grid-cols-2 gap-8 items-start">
            <div className="bg-white rounded-2xl shadow-lg p-6 border border-slate-200">
              <h2 className="text-2xl font-semibold">Inloggen</h2>
              <div className="mt-4">
                <label className="block text-sm">Deelnemer</label>
                <select className="mt-1 w-full border rounded-xl px-3 py-2" value={name} onChange={e => setName(e.target.value)}>
                  {CONFIG.participants.map(p => <option key={p.name} value={p.name}>{p.name}</option>)}
                </select>
              </div>
              <div className="mt-4">
                <label className="block text-sm">Pincode</label>
                <input className="mt-1 w-full border rounded-xl px-3 py-2" type="password" inputMode="numeric" value={pin} onChange={e => setPin(e.target.value)} placeholder="Vier cijfers" />
              </div>
              <div className="mt-4">
                <label className="block text-sm">Niveau</label>
                <div className="mt-2 grid grid-cols-3 gap-2">
                  {["Easy","Medium","Hard"].map(opt => (
                    <button key={opt} className={classNames("px-3 py-2 rounded-xl border", level===opt?"bg-slate-900 text-white":"bg-white")} onClick={() => setLevelLocal(opt)}>{opt}</button>
                  ))}
                </div>
                <p className="text-xs text-slate-600 mt-1">Let op, keuze is eenmalig en wordt vastgezet bij eerste inlog</p>
              </div>
              {error && <p className="mt-3 text-red-600">{error}</p>}
              <button className="mt-6 w-full bg-slate-900 text-white rounded-xl py-3" onClick={handleLogin}>Bevestig en start</button>
            </div>

            <div className="bg-white rounded-2xl shadow-lg p-6 border border-slate-200">
              <h3 className="text-xl font-semibold text-slate-900 mb-3">Your Contract with Yourself</h3>
              <p className="text-sm leading-relaxed text-slate-700">
                If you choose to stay hard you pick 2500 minutes. That is your contract with yourself.
                No one will sign it for you. Zone 2 is not a hobby. It is a choice to stop being average.
                It is 2500 minutes of silence where no one claps and no one cares. Every step, every pedal stroke,
                every breath teaches you to control the mind that wants comfort. You either build the engine or you stay soft.
                You either pay in sweat or you pay in regret. You want to walk into 2026 sharp, lean, ready. Then earn it now.
                Every minute counts. Every session is a brick in the wall between you and weakness. Stay hard.
              </p>
            </div>
          </div>
        );
      }

      function MainScreen({ user, db, allDays, setUser, totalFor, goalFor, remainingDaysFromToday, openModal, resetEntries, leaderboard }) {
        const name = user.name;
        const rec = db[name] || { level: null, entries: {} };
        const goal = goalFor(name);
        const total = totalFor(name);
        const remaining = Math.max(0, goal - total);

        const today = new Date();
        const { start, end } = challengeRange();
        const clampedStart = today < start ? start : today;
        const remDays = Math.max(0, remainingDaysFromToday(clampedStart));
        const neededPerDay = remDays > 0 ? Math.ceil(remaining / remDays) : remaining;

        const y = currentYear();
        const novCells = getMonthMatrix(y, 10);
        const decCells = getMonthMatrix(y, 11);

        // cumulatief tot en met dag
        function cumulativeUntil(ymd) {
          let sum = 0;
          for (const d of allDays) {
            sum += parseInt(rec.entries?.[d] || 0, 10);
            if (d === ymd) break;
          }
          return sum;
        }
        function planCumUntil(ymd) {
          if (!goal) return 0;
          const idx = allDays.indexOf(ymd); // 0-based
          if (idx < 0) return 0;
          const per = goal / allDays.length;
          return Math.round(per * (idx + 1));
        }

        function badges() {
          const arr = [];
          if (total >= 750) arr.push("750 minuten");
          if (total >= 1500) arr.push("1500 minuten");
          if (total >= 1750) arr.push("1750 minuten");
          return arr;
        }

        function dayCell(d) {
          if (!d) return <div className="h-16 rounded-xl bg-slate-50"></div>;
          const ymd = YMD(d);
          if (d < start || d > end) return <div className="h-16 rounded-xl bg-slate-50"></div>;
          const minutes = parseInt(rec.entries?.[ymd] || 0, 10);
          const isToday = YMD(new Date()) === ymd;

          const cum = cumulativeUntil(ymd);
          const plan = planCumUntil(ymd);
          const delta = cum - plan;

          let borderClr = "border-slate-200";
          if (minutes > 0 && delta >= 0) borderClr = "border-emerald-400";
          else if (minutes > 0 && delta < 0) borderClr = "border-rose-300";

          return (
            <button
              key={ymd}
              onClick={() => openModal(ymd, minutes)}
              className={classNames("h-16 rounded-xl border p-2 text-left hover:shadow-sm transition", borderClr, isToday ? "ring-2 ring-slate-900" : "")}
              title={`Plan t/m vandaag ${plan} min, cumulatief ${cum} min`}
            >
              <div className="text-xs text-slate-600">{d.toLocaleDateString("nl-NL",{ day:"2-digit", month:"short" })}</div>
              <div className="text-sm font-semibold mt-1">{minutes} min</div>
            </button>
          );
        }

        return (
          <div className="grid lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 space-y-6">
              <Card>
                <div className="flex flex-wrap items-center justify-between gap-3">
                  <div>
                    <h2 className="text-2xl font-semibold">Welkom {name}</h2>
                    <p className="text-slate-600 text-sm">Doel {rec.level || "-"} {goal} minuten</p>
                  </div>
                  <div className="flex items-center gap-2">
                    <button className="px-3 py-2 rounded-xl border" onClick={() => setUser(null)}>Uitloggen</button>
                    <button className="px-3 py-2 rounded-xl border text-rose-700" onClick={() => resetEntries(name)}>Reset deelnemer</button>
                  </div>
                </div>

                <div className="mt-4 grid grid-cols-3 gap-3 text-center">
                  <Stat label="Tot nu toe" value={total} sub="minuten" />
                  <Stat label="Nog te gaan" value={remaining} sub="minuten" />
                  <Stat label="Benodigd per dag" value={neededPerDay} sub={remDays > 0 ? `over ${remDays} dagen` : "0 dagen"} />
                </div>

                {badges().length > 0 && (
                  <div className="mt-4 flex flex-wrap gap-2">
                    {badges().map(b => (
                      <span key={b} className="px-3 py-1 rounded-full bg-slate-900 text-white text-xs">{b}</span>
                    ))}
                  </div>
                )}
              </Card>

              <Card>
                <h3 className="text-xl font-semibold mb-2">November</h3>
                <div className="weekday-row text-xs text-slate-500 mb-2">
                  {WEEKDAYS.map(w => <div key={w} className="text-center">{w}</div>)}
                </div>
                <div className="month-grid">
                  {novCells.map((d, i) => <div key={i}>{dayCell(d)}</div>)}
                </div>
              </Card>

              <Card>
                <h3 className="text-xl font-semibold mb-2">December</h3>
                <div className="weekday-row text-xs text-slate-500 mb-2">
                  {WEEKDAYS.map(w => <div key={w} className="text-center">{w}</div>)}
                </div>
                <div className="month-grid">
                  {decCells.map((d, i) => <div key={i}>{dayCell(d)}</div>)}
                </div>
              </Card>
            </div>

            <div className="space-y-6">
              <Leaderboard leaderboard={leaderboard} />
            </div>
          </div>
        );
      }

      const Card = ({ children }) => <div className="bg-white rounded-2xl shadow-lg p-6 border border-slate-200">{children}</div>;

      const Stat = ({ label, value, sub }) => (
        <div className="bg-slate-50 rounded-xl p-4">
          <div className="text-xs text-slate-600">{label}</div>
          <div className="text-2xl font-semibold">{value}</div>
          <div className="text-xs text-slate-600">{sub}</div>
        </div>
      );

      const Leaderboard = ({ leaderboard }) => (
        <Card>
          <h3 className="text-xl font-semibold mb-3 text-center">Leaderboard</h3>
          <div className="space-y-2">
            {leaderboard.map(r => (
              <div key={r.name} className="flex justify-between text-sm py-2 border-b border-slate-100">
                <div className="font-semibold">{r.name}</div>
                <div>{r.sum}/{r.goal} ({r.pct}%)</div>
              </div>
            ))}
          </div>
        </Card>
      );

      // ================== MODAL MET SLIDER ==================
      function MinutesModal({ dateYMD, initialValue, onCancel, onSave }) {
        const [val, setVal] = React.useState(Number.isFinite(initialValue) ? initialValue : 0);
        const d = fromYMD(dateYMD);
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
            <div className="w-full max-w-md bg-white rounded-2xl shadow-xl border border-slate-200 p-6">
              <div className="text-center">
                <h4 className="text-xl font-semibold">Minuten loggen</h4>
                <p className="text-sm text-slate-600 mt-1">{d.toLocaleDateString("nl-NL",{ weekday:"long", day:"2-digit", month:"long" })}</p>
              </div>
              <div className="mt-6">
                <input
                  type="range"
                  min="0"
                  max="180"
                  step="1"
                  value={val}
                  onChange={e => setVal(parseInt(e.target.value, 10) || 0)}
                  className="w-full"
                />
                <div className="mt-3 flex items-center justify-center gap-2">
                  <input
                    type="text"
                    inputMode="numeric"
                    pattern="[0-9]*"
                    className="w-24 border rounded-lg px-3 py-2 text-center"
                    value={String(val)}
                    onChange={e => {
                      const v = e.target.value.replace(/\D+/g, "").slice(0,4);
                      setVal(v === "" ? 0 : Math.min(180, parseInt(v,10)));
                    }}
                    onBlur={() => setVal(prev => Math.min(180, Math.max(0, prev)))}
                  />
                  <span className="text-sm text-slate-600">minuten</span>
                </div>
              </div>
              <div className="mt-6 flex justify-end gap-2">
                <button className="px-4 py-2 rounded-xl border" onClick={onCancel}>Annuleren</button>
                <button className="px-4 py-2 rounded-xl bg-slate-900 text-white" onClick={() => onSave(val)}>Opslaan</button>
              </div>
            </div>
          </div>
        );
      }

      // ================ MOUNT ================
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>

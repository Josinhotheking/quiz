<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Outlive Zone 2 Challenge</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      html, body, #root { height: 100%; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      // ================== CONFIG ==================
      const CONFIG = {
        participants: [
          { name: "Jos", pin: "1111" },
          { name: "Tom", pin: "2222" },
          { name: "Gerben Jan", pin: "3333" },
        ],
        goals: { Easy: 1750, Medium: 2100, Hard: 2500 },
        GAS_WEB_APP_URL: "",
      };

      // ================== HELPERS ==================
      const YMD = d => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
      const fromYMD = s => new Date(`${s}T00:00:00`);
      const isFuture = d => fromYMD(d) > new Date();

      function currentChallengeRange() {
        const year = new Date().getFullYear();
        const start = new Date(`${year}-11-01T00:00:00`);
        const end = new Date(`${year}-12-31T00:00:00`);
        return { start, end };
      }

      function enumerateDays(start, end) {
        const arr = [];
        const d = new Date(start);
        while (d <= end) {
          arr.push(YMD(d));
          d.setDate(d.getDate() + 1);
        }
        return arr;
      }

      function radialStyle() {
        return {
          background:
            "radial-gradient(1200px circle at 50% 20%, rgba(255,255,255,1) 0%, rgba(255,255,255,1) 25%, rgba(210,236,255,0.9) 38%, rgba(232,249,225,0.85) 52%, rgba(255,238,246,0.85) 66%, rgba(255,255,255,1) 100%)",
          minHeight: "100vh",
        };
      }

      const classNames = (...a) => a.filter(Boolean).join(" ");
      const QUOTES = [
        "When you think you're done, you're only 40% done.",
        "Stay disciplined when motivation fades.",
        "You don't find toughness, you build it.",
        "Every minute counts. Stay hard.",
        "It’s you vs you, no one else.",
        "Be uncommon amongst uncommon people.",
        "Suffering is the true test of life.",
      ];
      const pickQuote = () => QUOTES[Math.floor(Math.random() * QUOTES.length)];

      const LS_KEY = "outlive_zone2_data_v1";
      const loadLocal = () => { try { return JSON.parse(localStorage.getItem(LS_KEY)) || {}; } catch { return {}; } };
      const saveLocal = db => localStorage.setItem(LS_KEY, JSON.stringify(db));

      // ================== APP ==================
      function App() {
        const { start, end } = React.useMemo(() => currentChallengeRange(), []);
        const days = React.useMemo(() => enumerateDays(start, end), [start, end]);
        const [db, setDb] = React.useState(loadLocal());
        const [user, setUser] = React.useState(null);
        const [quote, setQuote] = React.useState("");
        const [pending, setPending] = React.useState(null);

        React.useEffect(() => saveLocal(db), [db]);

        function ensureUser(name) {
          setDb(cur => {
            if (!cur[name]) cur[name] = { level: null, entries: {} };
            return { ...cur };
          });
        }

        function setLevel(name, level) {
          setDb(cur => {
            const next = { ...cur };
            next[name] = next[name] || { level: null, entries: {} };
            if (!next[name].level) next[name].level = level;
            return next;
          });
        }

        function setMinutes(name, ymd, mins) {
          setDb(cur => {
            const next = { ...cur };
            next[name] = next[name] || { level: null, entries: {} };
            next[name].entries = { ...next[name].entries, [ymd]: mins };
            return next;
          });
        }

        function totalFor(n) {
          const rec = db[n];
          if (!rec) return 0;
          return Object.values(rec.entries || {}).reduce((a, b) => a + (parseInt(b || 0, 10) || 0), 0);
        }

        function goalFor(n) {
          const rec = db[n];
          if (!rec || !rec.level) return 0;
          return CONFIG.goals[rec.level];
        }

        function planUntilDay(goal, total, ymd, all) {
          const i = all.indexOf(ymd) + 1;
          return Math.round((goal / total) * i);
        }

        function planUntilToday(n) {
          const rec = db[n];
          if (!rec || !rec.level) return 0;
          const goal = CONFIG.goals[rec.level];
          const today = YMD(new Date());
          let idx = days.indexOf(today) + 1;
          if (idx < 0) idx = 0;
          if (idx > days.length) idx = days.length;
          return Math.round((goal / days.length) * idx);
        }

        const leaderboard = React.useMemo(
          () =>
            CONFIG.participants
              .map(p => {
                const g = goalFor(p.name),
                  s = totalFor(p.name);
                const pct = g ? Math.min(100, Math.round((s / g) * 100)) : 0;
                const onPlan = g ? s - planUntilToday(p.name) : 0;
                return { name: p.name, goal: g, sum: s, pct, onPlan };
              })
              .sort((a, b) => b.pct - a.pct || b.sum - a.sum),
          [db]
        );

        return (
          <div style={radialStyle()} className="text-slate-900">
            <div className="max-w-6xl mx-auto px-4 py-8">
              <Header />
              {!user ? (
                <LoginScreen onLogin={setUser} ensureUser={ensureUser} setLevel={setLevel} />
              ) : (
                <MainScreen
                  user={user}
                  setUser={setUser}
                  days={days}
                  db={db}
                  setMinutes={setMinutes}
                  totalFor={totalFor}
                  goalFor={goalFor}
                  planUntilDay={planUntilDay}
                  planUntilToday={planUntilToday}
                  leaderboard={leaderboard}
                  showConfirm={(d, m) => setPending({ date: d, minutes: m })}
                />
              )}
              {pending && (
                <ConfirmModal
                  date={pending.date}
                  minutes={pending.minutes}
                  onConfirm={() => {
                    setMinutes(user.name, pending.date, pending.minutes);
                    setPending(null);
                    setQuote(pickQuote());
                  }}
                  onCancel={() => setPending(null)}
                />
              )}
              {quote && (
                <div className="fixed inset-x-0 bottom-0 p-4">
                  <div className="max-w-3xl mx-auto rounded-2xl bg-white/90 backdrop-blur shadow-lg p-4 text-center border border-slate-200">
                    <p className="text-lg font-medium italic">{quote}</p>
                    <button
                      className="mt-3 px-4 py-2 rounded-xl bg-slate-900 text-white"
                      onClick={() => setQuote("")}
                    >
                      Sluiten
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      // ================== COMPONENTS ==================
      const Header = () => (
        <div className="mb-8 text-center">
          <div className="text-xs tracking-widest text-slate-600">Zone 2 Challenge</div>
          <h1 className="text-4xl md:text-5xl font-semibold tracking-tight mt-1">Outlive Zone 2</h1>
          <p className="text-slate-600 mt-2">November – December</p>
        </div>
      );

      function LoginScreen({ onLogin, ensureUser, setLevel }) {
        const [name, setName] = React.useState(CONFIG.participants[0].name);
        const [pin, setPin] = React.useState("");
        const [level, setLevelLocal] = React.useState("Easy");
        const [error, setError] = React.useState("");
        function handleLogin() {
          const p = CONFIG.participants.find(x => x.name === name);
          if (!p || p.pin !== pin) {
            setError("Verkeerde pincode");
            return;
          }
          ensureUser(name);
          setLevel(name, level);
          onLogin({ name });
        }
        return (
          <div className="max-w-3xl mx-auto grid md:grid-cols-2 gap-8">
            <div className="bg-white rounded-2xl shadow-lg p-6 border border-slate-200">
              <h2 className="text-2xl font-semibold">Inloggen</h2>
              <div className="mt-4">
                <label className="block text-sm">Deelnemer</label>
                <select
                  className="mt-1 w-full border rounded-xl px-3 py-2"
                  value={name}
                  onChange={e => setName(e.target.value)}
                >
                  {CONFIG.participants.map(p => (
                    <option key={p.name} value={p.name}>
                      {p.name}
                    </option>
                  ))}
                </select>
              </div>
              <div className="mt-4">
                <label className="block text-sm">Pincode</label>
                <input
                  className="mt-1 w-full border rounded-xl px-3 py-2"
                  type="password"
                  inputMode="numeric"
                  value={pin}
                  onChange={e => setPin(e.target.value)}
                  placeholder="Vier cijfers"
                />
              </div>
              <div className="mt-4">
                <label className="block text-sm">Niveau</label>
                <div className="mt-2 grid grid-cols-3 gap-2">
                  {["Easy", "Medium", "Hard"].map(opt => (
                    <button
                      key={opt}
                      className={classNames(
                        "px-3 py-2 rounded-xl border",
                        level === opt ? "bg-slate-900 text-white" : "bg-white"
                      )}
                      onClick={() => setLevelLocal(opt)}
                    >
                      {opt}
                    </button>
                  ))}
                </div>
                <p className="text-xs text-slate-600 mt-1">
                  Let op, keuze is eenmalig en wordt vastgezet bij eerste inlog.
                </p>
              </div>
              {error && <p className="mt-3 text-red-600">{error}</p>}
              <button
                className="mt-6 w-full bg-slate-900 text-white rounded-xl py-3"
                onClick={handleLogin}
              >
                Bevestig en start
              </button>
            </div>

            <div className="bg-white rounded-2xl shadow-lg p-6 border border-slate-200">
              <h3 className="text-xl font-semibold">Your Contract with Yourself</h3>
              <p className="mt-3 text-sm text-slate-700 leading-relaxed">
                If you choose to stay hard you pick 2500 minutes. That is your contract with yourself.
                No one will sign it for you. Zone 2 is not a hobby. It is a choice to stop being
                average. It is 2500 minutes of silence where no one claps and no one cares. Every
                step, every pedal stroke, every breath teaches you to control the mind that wants
                comfort. You either build the engine or you stay soft. You either pay in sweat or you
                pay in regret. You want to walk into 2026 sharp, lean, ready. Then earn it now. Every
                minute counts. Every session is a brick in the wall between you and weakness. Stay
                hard.
              </p>
            </div>
          </div>
        );
      }

      function MainScreen({ user, setUser, days, db, setMinutes, totalFor, goalFor, planUntilDay, planUntilToday, leaderboard, showConfirm }) {
        const name = user.name;
        const rec = db[name] || { level: null, entries: {} };
        const goal = goalFor(name),
          total = totalFor(name),
          remaining = Math.max(0, goal - total);
        const [allowFuture, setAllowFuture] = React.useState(false);
        return (
          <div className="grid lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 space-y-6">
              <Card>
                <div className="flex flex-wrap items-center justify-between gap-3">
                  <div>
                    <h2 className="text-2xl font-semibold">Welkom {name}</h2>
                    <p className="text-slate-600 text-sm">
                      Doel {rec.level} {goal} minuten
                    </p>
                  </div>
                  <div className="text-right">
                    <div className="text-3xl font-semibold">{total}</div>
                    <div className="text-sm text-slate-600">minuten tot nu</div>
                  </div>
                </div>
                <Progress value={goal ? Math.min(100, Math.round((total / goal) * 100)) : 0} />
                <div className="grid grid-cols-3 gap-3 mt-3 text-center">
                  <Stat label="Resteert" value={remaining} sub="minuten" />
                  <Stat label="Plan tot vandaag" value={planUntilToday(name)} sub="minuten" />
                  <Stat label="Verschil vs plan" value={total - planUntilToday(name)} sub="minuten" />
                </div>
                <div className="mt-4 flex gap-3 items-center">
                  <button className="px-3 py-2 rounded-xl border" onClick={() => setUser(null)}>
                    Uitloggen
                  </button>
                  <label className="flex items-center gap-2 text-sm ml-auto">
                    <input
                      type="checkbox"
                      checked={allowFuture}
                      onChange={e => setAllowFuture(e.target.checked)}
                    />
                    Override toekomstige dagen
                  </label>
                </div>
              </Card>
              <CalendarGrid
                days={days}
                entries={rec.entries}
                onProposeChange={(d, m) => showConfirm(d, m)}
                goal={goal}
                planUntilDay={d => planUntilDay(goal, days.length, d, days)}
                allowFuture={allowFuture}
              />
            </div>
            <div className="space-y-6">
              <Leaderboard leaderboard={leaderboard} />
            </div>
          </div>
        );
      }

      const Card = ({ children }) => (
        <div className="bg-white rounded-2xl shadow-lg p-6 border border-slate-200">{children}</div>
      );
      const Stat = ({ label, value, sub }) => (
        <div className="bg-slate-50 rounded-xl p-3">
          <div className="text-xs text-slate-600">{label}</div>
          <div className="text-2xl font-semibold">{value}</div>
          <div className="text-xs text-slate-600">{sub}</div>
        </div>
      );
      const Progress = ({ value }) => (
        <div className="mt-4 h-3 w-full bg-slate-100 rounded-full">
          <div className="h-3 bg-slate-900 rounded-full transition-all" style={{ width: `${value}%` }} />
        </div>
      );
      const Leaderboard = ({ leaderboard }) => (
        <Card>
          <h3 className="text-xl font-semibold mb-3 text-center">Leaderboard</h3>
          {leaderboard.map(r => (
            <div
              key={r.name}
              className="flex justify-between text-sm py-1 border-b border-slate-100"
            >
              <div>{r.name}</div>
              <div>
                {r.sum}/{r.goal} ({r.pct}%)
              </div>
            </div>
          ))}
        </Card>
      );

      function CalendarGrid({ days, entries, onProposeChange, goal, planUntilDay, allowFuture }) {
        const today = YMD(new Date());
        return (
          <Card>
            <h3 className="text-xl font-semibold mb-1">Jouw 61 dagen</h3>
            <p className="text-sm text-slate-600 mb-4">
              Dag 1 is 1 november, dag 61 is 31 december
            </p>
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
              {days.map(d => {
                const m = parseInt(entries[d] || 0, 10);
                const plan = planUntilDay(d);
                const future = !allowFuture && isFuture(d);
                return (
                  <div
                    key={d}
                    className={classNames(
                      "rounded-xl border p-3 flex flex-col",
                      future ? "opacity-50" : "bg-white"
                    )}
                  >
                    <div className="text-xs text-slate-600">
                      {fromYMD(d).toLocaleDateString("
